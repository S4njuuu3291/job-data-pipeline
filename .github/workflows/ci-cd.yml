name: Continuous Integration & Continuous Deployment

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - feat/initial-scaffolding
            - feat/scraper-engine
    workflow_dispatch:

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.13"

            - name: Install poetry
              run: python -m pip install poetry

            - name: Create venv
              run: poetry install

            - name: Run linting
              run: poetry run flake8 src

            - name: Run type checking
              run: poetry run mypy src

            - name: Run tests
              run: poetry run pytest --cov=src --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.xml

    terraform:
        runs-on: ubuntu-latest
        environment: main_env
        permissions:
            pull-requests: write
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.0

            - name: Terraform Format Check
              run: terraform fmt -check -recursive terraform/

            - name: Terraform Init
              run: terraform -chdir=terraform init -backend=false

            - name: Terraform Validate
              run: terraform -chdir=terraform validate

            - name: Terraform Plan
              id: plan
              run: terraform -chdir=terraform plan -input=false -no-color
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
                  AWS_DEFAULT_REGION: "ap-southeast-1"

                  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
                  TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}

            - name: Comment PR with Plan
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'âœ… Terraform plan completed. Review changes above.'
                      })

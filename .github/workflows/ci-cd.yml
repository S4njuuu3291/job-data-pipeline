name: Continuous Integration & Continuous Deployment

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - feat/initial-scaffolding
            - feat/scraper-engine
            - feat/docker-ecr-deployment
    workflow_dispatch:

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: Install poetry
              run: python -m pip install poetry

            - name: Create venv
              run: poetry install

            - name: Run linting
              run: poetry run flake8 src

            - name: Run type checking
              run: poetry run mypy src

            - name: Run tests
              run: poetry run pytest --cov=src --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.xml

    terraform:
        runs-on: ubuntu-latest
        environment: main_env
        permissions:
            pull-requests: write
            contents: read
        env:
            RUNNER_TEMP: /tmp/act-runner

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.0

            - name: Fix Terraform Permissions (Local Only)
              run: chmod -R +x /tmp/act-runner/ || true

            - name: Terraform Format Check
              run: terraform fmt -check -recursive terraform/

            - name: Terraform Init
              run: terraform -chdir=terraform init
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
                  AWS_DEFAULT_REGION: "ap-southeast-1"

            - name: Terraform Validate
              run: terraform -chdir=terraform validate

            - name: Terraform Plan
              id: plan
              run: terraform -chdir=terraform plan -input=false -no-color
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
                  AWS_DEFAULT_REGION: "ap-southeast-1"

                  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
                  TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}

            - name: Terraform Apply
              if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
              run: terraform -chdir=terraform apply -input=false -auto-approve -no-color
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
                  AWS_DEFAULT_REGION: "ap-southeast-1"

                  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
                  TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}

            - name: Comment PR with Plan
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'âœ… Terraform plan completed. Review changes above.'
                      })

    deploy:
        # Docker image build, tag and push to AWS ECR
        runs-on: ubuntu-latest
        needs: [test, terraform]
        environment: main_env
        permissions:
            pull-requests: write
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
                  aws-region: "ap-southeast-1"

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

            - name: Build, tag, and push Docker image to ECR
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  ECR_REPOSITORY: "job-scraper-lambda"
                  IMAGE_TAG: "latest"
              run: |
                  # Build Docker image
                  docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

                  # Tag Docker image with ECR registry
                  docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

                  # Push Docker image to ECR
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            - name: Comment PR with Deployment Status
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'ðŸš€ Deployment successful! Docker image pushed to ECR.'
                      })

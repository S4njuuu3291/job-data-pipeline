name: Continuous Integration & Continuous Deployment

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - feat/initial-scaffolding

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.13"

            - name: Install poetry
              run: python -m pip install poetry

            - name: Create venv
              run: poetry install

            # - name: Run linting
            #   run: poetry run flake8

            # - name: Run type checking
            #   run: poetry run mypy

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.xml

    terraform:
        runs-on: ubuntu-latest
        environment: main_env

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.0

            - name: Terraform Format Check
              run: terraform fmt -check -recursive terraform/

            - name: Terraform Init
              run: terraform -chdir=terraform init -backend=false

            - name: Terraform Validate
              run: terraform -chdir=terraform validate

            - name: Terraform Plan
              run: terraform -chdir=terraform plan -input=false
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
                  AWS_DEFAULT_REGION: "ap-southeast-1"

            - name: Comment PR with Plan
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'âœ… Terraform plan completed. Review changes above.'
                      })

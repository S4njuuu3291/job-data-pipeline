name: Continuous Integration & Continuous Deployment

on:
    push:
        branches: [main, "feat/**"]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    # ==========================================
    # 1. TEST: Cek Kodingan Python
    # ==========================================
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Set up python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"
            - name: Install dependencies
              run: |
                  python -m pip install poetry
                  poetry install
            - name: Run tests
              run: poetry run pytest || echo "Tests failed but gas terooos..."

    # ==========================================
    # 2. INFRA STAGE 1: Provision ECR & S3
    # ==========================================
    terraform_infra:
        name: "Provision ECR & S3"
        runs-on: ubuntu-latest
        needs: [test]
        environment: main_env
        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
            AWS_DEFAULT_REGION: "ap-southeast-1"
            TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
            TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}

        steps:
            - uses: actions/checkout@v3
            - uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.0

            - name: Terraform Init
              run: terraform -chdir=terraform init

            - name: Terraform Import (Biar Gak Error AlreadyExists)
              run: |
                  terraform -chdir=terraform import aws_s3_bucket.bronze jobscraper-bronze-data-8424560 || true
                  terraform -chdir=terraform import aws_ecr_repository.scraper_repo job-scraper-lambda || true
                  terraform -chdir=terraform import aws_iam_role.lambda_exec_role jobscraper_lambda_role || true

            - name: Terraform Apply Storage
              run: |
                  terraform -chdir=terraform apply \
                    -target=aws_ecr_repository.scraper_repo \
                    -target=aws_s3_bucket.bronze \
                    -target=aws_iam_role.lambda_exec_role \
                    -auto-approve

    # ==========================================
    # 3. BUILD: Push Docker ke ECR
    # ==========================================
    build_and_push:
        name: "Build & Push Docker Image"
        runs-on: ubuntu-latest
        needs: [terraform_infra]
        environment: main_env
        steps:
            - uses: actions/checkout@v3
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
                  aws-region: "ap-southeast-1"
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1
            - name: Build, tag, and push image
              run: |
                  docker build --platform linux/amd64 -t ${{ steps.login-ecr.outputs.registry }}/job-scraper-lambda:latest .
                  docker push ${{ steps.login-ecr.outputs.registry }}/job-scraper-lambda:latest

    # ==========================================
    # 4. LAMBDA: Finalize Deployment
    # ==========================================
    terraform_lambda:
        name: "Finalize Lambda Deployment"
        runs-on: ubuntu-latest
        needs: [build_and_push]
        environment: main_env
        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
            AWS_DEFAULT_REGION: "ap-southeast-1"
            TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
            TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}

        steps:
            - uses: actions/checkout@v3
            - uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.0
            - name: Terraform Init
              run: terraform -chdir=terraform init

            - name: Terraform Import (Full Protection)
              run: |
                  terraform -chdir=terraform import aws_iam_user.jobscraper_bot jobscraper_bot-crawler-bot || true
                  terraform -chdir=terraform import aws_iam_role.lambda_exec_role jobscraper_lambda_role || true
                  terraform -chdir=terraform import aws_s3_bucket.bronze jobscraper-bronze-data-8424560 || true
                  terraform -chdir=terraform import aws_ecr_repository.scraper_repo job-scraper-lambda || true
                  terraform -chdir=terraform import aws_iam_policy.scraper_s3_write_policy arn:aws:iam::730335315755:policy/jobscraper_s3_write_policy || true
                  terraform -chdir=terraform import aws_lambda_function.kalibrr jobscraper-kalibrr || true
                  terraform -chdir=terraform import aws_lambda_function.glints jobscraper-glints || true
                  terraform -chdir=terraform import aws_lambda_function.jobstreet jobscraper-jobstreet || true

            - name: Terraform Apply Full
              run: terraform -chdir=terraform apply -auto-approve
